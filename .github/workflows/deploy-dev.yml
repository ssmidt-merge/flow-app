name: Deploy to Cloud Run (Development)

on:
  push:
    branches:
      - master  # Deploy from master branch

env:
  PROJECT_ID: flow-proto-478014  # Update with your GCP project ID
  REGION: us-central1  # Update with your preferred region
  SERVICE_NAME: flow-app-dev  # Update with your service name
  ARTIFACT_REPO: flow-app  # Update with your Artifact Registry repo name

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER_DEV }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT_DEV }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Docker image
        run: |
          docker build \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:latest \
            .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:latest

      - name: Get Current Revision (for rollback)
        id: get_revision
        continue-on-error: true
        run: |
          # Store current revision in case we need to rollback
          CURRENT_REVISION=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --format='value(status.latestReadyRevisionName)' 2>/dev/null || echo "")
          echo "CURRENT_REVISION=$CURRENT_REVISION" >> $GITHUB_OUTPUT
          if [ -n "$CURRENT_REVISION" ]; then
            echo "Current revision: $CURRENT_REVISION (will rollback to this if deployment fails)"
          else
            echo "No existing revision found (first deployment)"
          fi

      - name: Get or Set Service URL
        id: get_url
        run: |
          # Try to get existing service URL, or use placeholder for first deployment
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --format='value(status.url)' 2>/dev/null || echo "https://flow-app-dev-placeholder.run.app")
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Using SERVICE_URL: $SERVICE_URL"

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --project ${{ env.PROJECT_ID }} \
            --port 8080 \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --add-cloudsql-instances ${{ secrets.CLOUD_SQL_CONNECTION_NAME_DEV }} \
            --set-env-vars DATABASE_URL=${{ secrets.DATABASE_URL_DEV }} \
            --set-env-vars SECRET_KEY=${{ secrets.SECRET_KEY }} \
            --set-env-vars ALGORITHM=HS256 \
            --set-env-vars ACCESS_TOKEN_EXPIRE_MINUTES=30 \
            --set-env-vars FRONTEND_URL=${{ steps.get_url.outputs.SERVICE_URL }} \
            --set-env-vars BACKEND_URL=${{ steps.get_url.outputs.SERVICE_URL }}

      - name: Get Service URL
        id: final_url
        run: |
          SERVICE_URL=$(gcloud run services list \
            --filter="metadata.name=${{ env.SERVICE_NAME }}" \
            --region ${{ env.REGION }} \
            --format='value(status.url)' \
            --project ${{ env.PROJECT_ID }})
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Service URL: $SERVICE_URL"

      - name: Health Check
        id: health_check
        run: |
          echo "Performing health check on deployed service..."
          SERVICE_URL="${{ steps.final_url.outputs.SERVICE_URL }}"

          # Wait for service to be ready (max 2 minutes)
          MAX_ATTEMPTS=12
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            echo "Health check attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/health" || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Health check passed! Service is responding with HTTP $HTTP_CODE"
              exit 0
            fi

            echo "Service returned HTTP $HTTP_CODE, waiting 10 seconds..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Display Deployment Success
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Deployment to DEV completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“ Service URL: ${{ steps.final_url.outputs.SERVICE_URL }}"
          echo "ğŸ·ï¸  Image: ${{ github.sha }}"
          echo "âœ… Health check: Passed"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Add to workflow summary
          echo "## ğŸš€ Deployment to DEV Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ${{ env.PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Service URL" >> $GITHUB_STEP_SUMMARY
          echo "- **App:** ${{ steps.final_url.outputs.SERVICE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check:** âœ… Passed" >> $GITHUB_STEP_SUMMARY

      - name: Rollback on Failure
        if: failure() && steps.get_revision.outputs.CURRENT_REVISION != ''
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Deployment or health check failed!"
          echo "ğŸ”„ Rolling back to previous revision..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --to-revisions=${{ steps.get_revision.outputs.CURRENT_REVISION }}=100 \
            --platform managed \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }}

          echo "âœ… Rollback completed. Service restored to revision: ${{ steps.get_revision.outputs.CURRENT_REVISION }}"

          # Verify rollback
          CURRENT=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --project ${{ env.PROJECT_ID }} \
            --format='value(status.latestReadyRevisionName)')
          echo "Current active revision: $CURRENT"
